name: Cleanup Whitelist

on:
  schedule:
    - cron: '0 0 * * *' # Run once every day at midnight
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Remove old entries from local whitelist
        run: |
          if [ -f "allowlist.txt" ]; then
            echo "Cleaning up local allowlist.txt..."
            
            # Calculate cutoff date (3 months ago)
            cutoff_date=$(date -d "3 months ago" +%s)
            
            # Temporary file for valid entries
            touch allowlist.tmp
            
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip empty lines
              if [ -z "$line" ]; then continue; fi
              
              # Skip pure comments (lines starting with #)
              if [[ "$line" =~ ^[[:space:]]*# ]]; then
                echo "$line" >> allowlist.tmp
                continue
              fi
              
              # Check for example.org (example rule)
              if echo "$line" | grep -q "||example.org\^"; then
                 # Always update example.org to current date
                 echo "||example.org^ # $(date +%Y-%m-%d)" >> allowlist.tmp
                 continue
              fi

              # Extract date from line (assumes format: rule # YYYY-MM-DD)
              # Look for date at end of line after #
              entry_date_str=$(echo "$line" | grep -oE '#[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}$' | sed 's/^#[[:space:]]*//' || true)
              
              if [ -n "$entry_date_str" ]; then
                # Convert entry date to seconds
                entry_date=$(date -d "$entry_date_str" +%s 2>/dev/null || echo "0")
                
                # Check if entry is newer than cutoff
                if [ "$entry_date" -ge "$cutoff_date" ]; then
                  echo "$line" >> allowlist.tmp
                else
                  # Remove only if it's actually an old date
                  if [ "$entry_date" -gt 0 ]; then
                    echo "Removing old entry: $line"
                  else
                    # Date parsing failed, keep the line
                    echo "$line" >> allowlist.tmp
                  fi
                fi
              else
                 # If no date found, keep the line as is
                 echo "$line" >> allowlist.tmp
              fi
            done < allowlist.txt
            
            # Check if file changed
            if cmp -s allowlist.txt allowlist.tmp; then
              echo "No changes to allowlist.txt"
              rm allowlist.tmp
            else
              mv allowlist.tmp allowlist.txt
              echo "Updated allowlist.txt with cleanup"
            fi
          else
            echo "No allowlist.txt found, nothing to clean up"
          fi

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          if [ -f "allowlist.txt" ]; then
            git add allowlist.txt
          fi
          if [[ -n $(git status -s) ]]; then
            git commit -m "Cleanup old entries from allowlist.txt"
            git push
          else
            echo "No changes to commit"
          fi
